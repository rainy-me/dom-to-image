import{__awaiter as e}from"tslib";const t="application/font-woff",n={woff:t,woff2:t,ttf:"application/font-truetype",eot:"application/vnd.ms-fontobject",png:"image/png",jpg:"image/jpeg",jpeg:"image/jpeg",gif:"image/gif",tiff:"image/tiff",svg:"image/svg+xml"},r=e=>{const t=/\.([^\.\/]*?)$/g.exec(e);return t?t[1]:""},o=(e,t)=>{const n=window.getComputedStyle(e).getPropertyValue(t);return parseFloat(n.replace("px",""))};var i={width:e=>{const t=o(e,"border-left-width"),n=o(e,"border-right-width");return e.scrollWidth+t+n},height:e=>{const t=o(e,"border-top-width"),n=o(e,"border-bottom-width");return e.scrollHeight+t+n},px:o,escapeXhtml:e=>e.replace(/#/g,"%23").replace(/\n/g,"%0A"),sleep:e=>new Promise(t=>{setTimeout(()=>{t()},e)}),escape:e=>e.replace(/([.*+?^${}()|\[\]\/\\])/g,"\\$1"),dataAsUrl:(e,t)=>"data:"+t+";base64,"+e,getAndEncode:(t,n)=>e(void 0,void 0,void 0,(function*(){var e;(null===(e=n)||void 0===e?void 0:e.cacheBust)&&(t+=(/\?/.test(t)?"&":"?")+(new Date).getTime());const r=yield fetch(t),o=yield r.blob();return URL.createObjectURL(o)})),makeImage:e=>new Promise((t,n)=>{const r=new Image;r.onload=()=>{t(r)},r.onerror=n,r.src=e}),uid:()=>{let e=0;return"u"+(()=>("0000"+(Math.random()*Math.pow(36,4)<<0).toString(36)).slice(-4))()+e++},resolveUrl:(e,t)=>{const n=document.implementation.createHTMLDocument(),r=n.createElement("base");n.head.appendChild(r);let o=n.createElement("a");return n.body.appendChild(o),r.href=t,o.href=e,o.href},canvasToBlob:t=>{if(t.toBlob)return new Promise(e=>{t.toBlob(e)});return(t=>e(void 0,void 0,void 0,(function*(){return new Promise(e=>{const n=window.atob(t.toDataURL().split(",")[1]),r=n.length,o=new Uint8Array(r);[...Array(r).keys()].forEach(e=>o[e]=n.charCodeAt(e)),e(new Blob([o],{type:"image/png"}))})})))(t)},isDataUrl:e=>-1!==e.search(/^(data:)/),mimeType:e=>{var t;const o=r(e).toLowerCase();return null!=(t=n[o])?t:""},parseExtension:r};const l=/url\(['"]?([^'"]+?)['"]?\)/g,a=e=>-1!==e.search(l),s=e=>{return[...e.matchAll(l)].map(e=>e[0]).filter(e=>!i.isDataUrl(e))},c=(t,n,r,o)=>e(void 0,void 0,void 0,(function*(){const e=r?i.resolveUrl(n,r):n,l=yield i.getAndEncode(e,o),a=i.dataAsUrl(l,i.mimeType(n));return t.replace((e=>new RegExp("(url\\(['\"]?)("+i.escape(e)+")(['\"]?\\))","g"))(n),"$1"+a+"$3")}));var d={inlineAll:function(t,n,r){return e(this,void 0,void 0,(function*(){if(!a(t))return t;const e=s(t);return yield Promise.all(e.map(e=>c(t,e,n,r))),t}))},shouldProcess:a,readUrls:s,inline:c};var u={inlineAll:t=>e(void 0,void 0,void 0,(function*(){const e=Array.from(document.styleSheets).flatMap(e=>Array.from(e.cssRules)).filter(e=>e.type===CSSRule.FONT_FACE_RULE).filter(e=>d.shouldProcess(e.style.getPropertyValue("src"))),n=(yield Promise.all(e.map(e=>{const t=e.parentStyleSheet.href;return d.inlineAll(e.cssText,t)}))).join("\n"),r=document.createElement("style");return t.appendChild(r),r.appendChild(document.createTextNode(n)),t}))};const g=t=>e(void 0,void 0,void 0,(function*(){if(!(t instanceof HTMLElement))return t;const n=t.style.getPropertyValue("background");if(!n)return t;const r=yield d.inlineAll(n);if(t.style.setProperty("background",r,t.style.getPropertyPriority("background")),t instanceof HTMLImageElement)return yield(t=>e(void 0,void 0,void 0,(function*(){if(i.isDataUrl(t.src))return;const e=yield i.getAndEncode(t.src),n=i.dataAsUrl(e,i.mimeType(t.src));return new Promise((e,r)=>{t.onload=e,t.onerror=r,t.src=n})})))(t),t;return yield Promise.all(Array.from(t.childNodes).map(e=>g(e)))}));var h={inlineAll:g};const f={imagePlaceholder:void 0,cacheBust:!1};function m(t,n={}){return e(this,void 0,void 0,(function*(){const r=Object.assign(Object.assign({},f),n);let o=yield function t(n,r){return e(this,void 0,void 0,(function*(){if(r&&!r(n))return;const o=yield(e=>e instanceof HTMLCanvasElement?i.makeImage(e.toDataURL()):new Promise(t=>t(e.cloneNode(!1))))(n),l=yield((n,r,o)=>e(this,void 0,void 0,(function*(){let i=n.childNodes;if(0===i.length)return r;Array.from(i).forEach(n=>e(this,void 0,void 0,(function*(){const e=yield t(n,o);e&&r.appendChild(e)})))})))(n,o,r);return A(n,l)}))}(t,n.filter);return o=yield u.inlineAll(o),function(e,t,n){e.setAttribute("xmlns","http://www.w3.org/1999/xhtml");const r=(new XMLSerializer).serializeToString(e),o=i.escapeXhtml(r);return"data:image/svg+xml;charset=utf-8,"+`<svg xmlns="http://www.w3.org/2000/svg" \n                  width="${t}" \n                  height="${n}"\n               >\n                    ${`\n        <foreignObject x="0" y="0" width="100%" height="100%">\n          ${o}\n        </foreignObject>`}\n               </svg>`}(o=(e=>{const{bgcolor:t,width:o,height:i}=n;t&&(e.style.backgroundColor=t),o&&(e.style.width=o+"px"),i&&(e.style.height=i+"px");const l=Object.assign(Object.assign({},e.style),r.style);return e.setAttribute("style",Object.entries(l).map((e,t)=>`${e}:${t}`).join(";")),e})(o=yield h.inlineAll(t)),n.width||i.width(t),n.height||i.height(t))}))}function p(t,n){return e(this,void 0,void 0,(function*(){return(yield b(t,n||{})).getContext("2d").getImageData(0,0,i.width(t),i.height(t)).data}))}function y(t,n={}){return e(this,void 0,void 0,(function*(){return(yield b(t,n)).toDataURL()}))}function v(t,n={}){return e(this,void 0,void 0,(function*(){return(yield b(t,n)).toDataURL("image/jpeg",n.quality||1)}))}function w(t,n={}){return e(this,void 0,void 0,(function*(){const e=yield b(t,n);return i.canvasToBlob(e)}))}function b(t,n){return e(this,void 0,void 0,(function*(){const e=yield m(t,n),r=yield i.makeImage(e);yield i.sleep(100);let o=document.createElement("canvas");if(o.width=n.width||i.width(t),o.height=n.height||i.height(t),n.bgcolor){let e=o.getContext("2d");e.fillStyle=n.bgcolor,e.fillRect(0,0,o.width,o.height)}return o.getContext("2d").drawImage(r,0,0),o}))}const A=(t,n)=>e(void 0,void 0,void 0,(function*(){if(!(n instanceof Element))return n;return(()=>{const e=window.getComputedStyle(t),r=n.style;e.cssText?r.cssText=e.cssText:Array.from(e).forEach(t=>{r.setProperty(t,e.getPropertyValue(t),e.getPropertyPriority(t))})})(),(()=>{[":before",":after"].forEach(t=>{e(t)});const e=e=>{const r=window.getComputedStyle(t,e),o=r.getPropertyValue("content");if(""===o||"none"===o)return;const l=i.uid();n.classList.add(l);const a=document.createElement("style");a.appendChild(((e,t,n)=>{let r=`.${e}:${t}`;let o=n.cssText?(e=>{let t=e.getPropertyValue("content");return e.cssText+" content: "+t+";"})(n):(e=>Array.from(e).map(t=>t+": "+e.getPropertyValue(t)+(e.getPropertyPriority(t)?" !important":"")).join("; ")+";")(n);return document.createTextNode(`${r}{${o}}`)})(l,e,r)),n.appendChild(a)}})(),t instanceof HTMLTextAreaElement&&(n.innerHTML=t.value),t instanceof HTMLInputElement&&n.setAttribute("value",t.value),n instanceof SVGElement&&(n.setAttribute("xmlns","http://www.w3.org/2000/svg"),n instanceof SVGRectElement&&["width","height"].forEach((function(e){let t=n.getAttribute(e);t&&n.style.setProperty(e,t)}))),n}));var P={toSvg:m,toPng:y,toJpeg:v,toBlob:w,toPixelData:p};export default P;export{w as toBlob,v as toJpeg,p as toPixelData,y as toPng};
