"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tslib=require("tslib");const WOFF="application/font-woff",JPEG="image/jpeg",mimes={woff:WOFF,woff2:WOFF,ttf:"application/font-truetype",eot:"application/vnd.ms-fontobject",png:"image/png",jpg:JPEG,jpeg:JPEG,gif:"image/gif",tiff:"image/tiff",svg:"image/svg+xml"},parseExtension=e=>{const t=/\.([^\.\/]*?)$/g.exec(e);return t?t[1]:""},mimeType=e=>{var t;const i=parseExtension(e).toLowerCase();return null!=(t=mimes[i])?t:""},isDataUrl=e=>-1!==e.search(/^(data:)/),canvasToBlob=e=>{if(e.toBlob)return new Promise(t=>{e.toBlob(t)});return(e=>tslib.__awaiter(void 0,void 0,void 0,(function*(){return new Promise(t=>{const i=window.atob(e.toDataURL().split(",")[1]),n=i.length,o=new Uint8Array(n);[...Array(n).keys()].forEach(e=>o[e]=i.charCodeAt(e)),t(new Blob([o],{type:"image/png"}))})})))(e)},resolveUrl=(e,t)=>{const i=document.implementation.createHTMLDocument(),n=i.createElement("base");i.head.appendChild(n);let o=i.createElement("a");return i.body.appendChild(o),n.href=t,o.href=e,o.href},uid=()=>{let e=0;return"u"+(()=>("0000"+(Math.random()*Math.pow(36,4)<<0).toString(36)).slice(-4))()+e++},makeImage=e=>new Promise((t,i)=>{const n=new Image;n.onload=()=>{t(n)},n.onerror=i,n.src=e}),getAndEncode=(e,t)=>tslib.__awaiter(void 0,void 0,void 0,(function*(){var i;(null===(i=t)||void 0===i?void 0:i.cacheBust)&&(e+=(/\?/.test(e)?"&":"?")+(new Date).getTime());const n=yield fetch(e),o=yield n.blob();return URL.createObjectURL(o)})),dataAsUrl=(e,t)=>"data:"+t+";base64,"+e,escape=e=>e.replace(/([.*+?^${}()|\[\]\/\\])/g,"\\$1"),sleep=e=>new Promise(t=>{setTimeout(()=>{t()},e)}),escapeXhtml=e=>e.replace(/#/g,"%23").replace(/\n/g,"%0A"),width=e=>{const t=px(e,"border-left-width"),i=px(e,"border-right-width");return e.scrollWidth+t+i},height=e=>{const t=px(e,"border-top-width"),i=px(e,"border-bottom-width");return e.scrollHeight+t+i},px=(e,t)=>{const i=window.getComputedStyle(e).getPropertyValue(t);return parseFloat(i.replace("px",""))};var util={width:width,height:height,px:px,escapeXhtml:escapeXhtml,sleep:sleep,escape:escape,dataAsUrl:dataAsUrl,getAndEncode:getAndEncode,makeImage:makeImage,uid:uid,resolveUrl:resolveUrl,canvasToBlob:canvasToBlob,isDataUrl:isDataUrl,mimeType:mimeType,parseExtension:parseExtension};const URL_REGEX=/url\(['"]?([^'"]+?)['"]?\)/g,shouldProcess=e=>-1!==e.search(URL_REGEX),readUrls=e=>{return[...e.matchAll(URL_REGEX)].map(e=>e[0]).filter(e=>!util.isDataUrl(e))},inline=(e,t,i,n)=>tslib.__awaiter(void 0,void 0,void 0,(function*(){const o=i?util.resolveUrl(t,i):t,r=yield util.getAndEncode(o,n),l=util.dataAsUrl(r,util.mimeType(t));return e.replace((e=>new RegExp("(url\\(['\"]?)("+util.escape(e)+")(['\"]?\\))","g"))(t),"$1"+l+"$3")}));function inlineAll(e,t,i){return tslib.__awaiter(this,void 0,void 0,(function*(){if(!shouldProcess(e))return e;const n=readUrls(e);return yield Promise.all(n.map(n=>inline(e,n,t,i))),e}))}var inliner={inlineAll:inlineAll,shouldProcess:shouldProcess,readUrls:readUrls,inline:inline};const inlineAll$1=e=>tslib.__awaiter(void 0,void 0,void 0,(function*(){const t=Array.from(document.styleSheets).flatMap(e=>Array.from(e.cssRules)).filter(e=>e.type===CSSRule.FONT_FACE_RULE).filter(e=>inliner.shouldProcess(e.style.getPropertyValue("src"))),i=(yield Promise.all(t.map(e=>{const t=e.parentStyleSheet.href;return inliner.inlineAll(e.cssText,t)}))).join("\n"),n=document.createElement("style");return e.appendChild(n),n.appendChild(document.createTextNode(i)),e}));var fontFaces={inlineAll:inlineAll$1};const inline$1=e=>tslib.__awaiter(void 0,void 0,void 0,(function*(){if(util.isDataUrl(e.src))return;const t=yield util.getAndEncode(e.src),i=util.dataAsUrl(t,util.mimeType(e.src));return new Promise((t,n)=>{e.onload=t,e.onerror=n,e.src=i})})),inlineAll$2=e=>tslib.__awaiter(void 0,void 0,void 0,(function*(){if(!(e instanceof HTMLElement))return e;const t=e.style.getPropertyValue("background");if(!t)return e;const i=yield inliner.inlineAll(t);if(e.style.setProperty("background",i,e.style.getPropertyPriority("background")),e instanceof HTMLImageElement)return yield inline$1(e),e;return yield Promise.all(Array.from(e.childNodes).map(e=>inlineAll$2(e)))}));var images={inlineAll:inlineAll$2};const defaultOptions={imagePlaceholder:void 0,cacheBust:!1};function toSvg(e,t={}){return tslib.__awaiter(this,void 0,void 0,(function*(){const i=Object.assign(Object.assign({},defaultOptions),t);let n=yield cloneNode(e,t.filter);return n=yield fontFaces.inlineAll(n),makeSvgDataUri(n=(e=>{const{bgcolor:n,width:o,height:r}=t;n&&(e.style.backgroundColor=n),o&&(e.style.width=o+"px"),r&&(e.style.height=r+"px");const l=Object.assign(Object.assign({},e.style),i.style);return e.setAttribute("style",Object.entries(l).map((e,t)=>`${e}:${t}`).join(";")),e})(n=yield images.inlineAll(e)),t.width||util.width(e),t.height||util.height(e))}))}function toPixelData(e,t){return tslib.__awaiter(this,void 0,void 0,(function*(){return(yield draw(e,t||{})).getContext("2d").getImageData(0,0,util.width(e),util.height(e)).data}))}function toPng(e,t={}){return tslib.__awaiter(this,void 0,void 0,(function*(){return(yield draw(e,t)).toDataURL()}))}function toJpeg(e,t={}){return tslib.__awaiter(this,void 0,void 0,(function*(){return(yield draw(e,t)).toDataURL("image/jpeg",t.quality||1)}))}function toBlob(e,t={}){return tslib.__awaiter(this,void 0,void 0,(function*(){const i=yield draw(e,t);return util.canvasToBlob(i)}))}function draw(e,t){return tslib.__awaiter(this,void 0,void 0,(function*(){const i=yield toSvg(e,t),n=yield util.makeImage(i);yield util.sleep(100);let o=document.createElement("canvas");if(o.width=t.width||util.width(e),o.height=t.height||util.height(e),t.bgcolor){let e=o.getContext("2d");e.fillStyle=t.bgcolor,e.fillRect(0,0,o.width,o.height)}return o.getContext("2d").drawImage(n,0,0),o}))}function cloneNode(e,t){return tslib.__awaiter(this,void 0,void 0,(function*(){if(t&&!t(e))return;const i=yield(e=>e instanceof HTMLCanvasElement?util.makeImage(e.toDataURL()):new Promise(t=>t(e.cloneNode(!1))))(e),n=yield((e,t,i)=>tslib.__awaiter(this,void 0,void 0,(function*(){let n=e.childNodes;if(0===n.length)return t;Array.from(n).forEach(e=>tslib.__awaiter(this,void 0,void 0,(function*(){const n=yield cloneNode(e,i);n&&t.appendChild(n)})))})))(e,i,t);return processClone(e,n)}))}const processClone=(e,t)=>tslib.__awaiter(void 0,void 0,void 0,(function*(){if(!(t instanceof Element))return t;return(()=>{const i=window.getComputedStyle(e),n=t.style;i.cssText?n.cssText=i.cssText:Array.from(i).forEach(e=>{n.setProperty(e,i.getPropertyValue(e),i.getPropertyPriority(e))})})(),(()=>{[":before",":after"].forEach(e=>{i(e)});const i=i=>{const n=window.getComputedStyle(e,i),o=n.getPropertyValue("content");if(""===o||"none"===o)return;const r=util.uid();t.classList.add(r);const l=document.createElement("style");l.appendChild(((e,t,i)=>{let n=`.${e}:${t}`;let o=i.cssText?(e=>{let t=e.getPropertyValue("content");return e.cssText+" content: "+t+";"})(i):(e=>Array.from(e).map(t=>t+": "+e.getPropertyValue(t)+(e.getPropertyPriority(t)?" !important":"")).join("; ")+";")(i);return document.createTextNode(`${n}{${o}}`)})(r,i,n)),t.appendChild(l)}})(),e instanceof HTMLTextAreaElement&&(t.innerHTML=e.value),e instanceof HTMLInputElement&&t.setAttribute("value",e.value),t instanceof SVGElement&&(t.setAttribute("xmlns","http://www.w3.org/2000/svg"),t instanceof SVGRectElement&&["width","height"].forEach((function(e){let i=t.getAttribute(e);i&&t.style.setProperty(e,i)}))),t}));function makeSvgDataUri(e,t,i){e.setAttribute("xmlns","http://www.w3.org/1999/xhtml");const n=(new XMLSerializer).serializeToString(e);return"data:image/svg+xml;charset=utf-8,"+`<svg xmlns="http://www.w3.org/2000/svg" \n                  width="${t}" \n                  height="${i}"\n               >\n                    ${`\n        <foreignObject x="0" y="0" width="100%" height="100%">\n          ${util.escapeXhtml(n)}\n        </foreignObject>`}\n               </svg>`}var index={toSvg:toSvg,toPng:toPng,toJpeg:toJpeg,toBlob:toBlob,toPixelData:toPixelData};exports.default=index,exports.toBlob=toBlob,exports.toJpeg=toJpeg,exports.toPixelData=toPixelData,exports.toPng=toPng;
